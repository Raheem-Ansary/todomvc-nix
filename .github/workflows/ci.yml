name: CI

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    env:
      HAS_DOCKERHUB: ${{ secrets.DOCKERHUB_USERNAME != '' && secrets.DOCKERHUB_TOKEN != '' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v27

      - name: Show flake
        run: nix flake show

      - name: Build rust backend (Nix)
        run: nix build .#packages.x86_64-linux.rust-backend

      - name: Build Docker image via Nix (Linux only)
        if: ${{ runner.os == 'Linux' }}
        run: nix build .#packages.x86_64-linux.rust-backend-image

      - name: Load image (Linux only)
        if: ${{ runner.os == 'Linux' }}
        run: docker load < result

      - name: Docker login (only if secrets exist)
        if: ${{ env.HAS_DOCKERHUB == 'true' && runner.os == 'Linux' }}
        run: echo '${{ secrets.DOCKERHUB_TOKEN }}' | docker login -u '${{ secrets.DOCKERHUB_USERNAME }}' --password-stdin

      - name: Push image (only if secrets exist)
        if: ${{ env.HAS_DOCKERHUB == 'true' && runner.os == 'Linux' }}
        run: |
          docker images
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/todomvc-rust-backend:latest

